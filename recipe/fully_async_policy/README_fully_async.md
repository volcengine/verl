# å®Œå…¨å¼‚æ­¥PPOè®­ç»ƒç³»ç»Ÿ (Fully Async Policy)

æœ¬æ–‡æ¡£ä»‹ç»äº†åŸºäº OneStepOffRayTrainer æˆç†Ÿå®ç°æ”¹è¿›çš„å®Œå…¨å¼‚æ­¥PPOè®­ç»ƒç³»ç»Ÿï¼Œè¯¥ç³»ç»Ÿå®ç°äº† Trainer å’Œ Rollouter çš„å®Œå…¨è§£è€¦ï¼Œæ”¯æŒå¼‚æ­¥æ ·æœ¬ç”Ÿæˆå’Œè®­ç»ƒã€‚

## ğŸš€ **ç³»ç»Ÿç‰¹æ€§**

### æ ¸å¿ƒç‰¹æ€§
- **å®Œå…¨å¼‚æ­¥è®­ç»ƒ**: Trainer å’Œ Rollouter åœ¨ç‹¬ç«‹çš„Ray Actorä¸­è¿è¡Œï¼Œå®ç°çœŸæ­£çš„å¹¶è¡Œå¤„ç†
- **æ™ºèƒ½æ–°é²œåº¦æ§åˆ¶**: åŸºäºå‚æ•°ç‰ˆæœ¬å’Œæ—¶é—´æˆ³çš„æ ·æœ¬æ–°é²œåº¦ç®¡ç†ï¼Œé˜²æ­¢è¿‡æœŸæ ·æœ¬å½±å“è®­ç»ƒ
- **å¥å£®çš„å‚æ•°åŒæ­¥**: æ”¹è¿›çš„å‚æ•°åŒæ­¥æœºåˆ¶ï¼Œæ”¯æŒé”™è¯¯é‡è¯•å’ŒçŠ¶æ€ç®¡ç†
- **ç®€åŒ–çš„æ¶ˆæ¯é˜Ÿåˆ—**: å»é™¤ZeroMQä¾èµ–ï¼Œä½¿ç”¨Ray-basedæ¶ˆæ¯ä¼ é€’ï¼Œæ›´ç¨³å®šå¯é 
- **å®Œå–„çš„ç›‘æ§**: è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œç»„ä»¶å¥åº·çŠ¶æ€ç›‘æ§

### æ”¹è¿›äº®ç‚¹
- **å‚è€ƒOneStepOffRayTrainer**: ä½¿ç”¨æˆç†Ÿçš„è®­ç»ƒé€»è¾‘ï¼Œç¡®ä¿è®­ç»ƒç¨³å®šæ€§
- **é”™è¯¯å¤„ç†å’Œæ¢å¤**: å®Œå–„çš„å¼‚å¸¸å¤„ç†å’Œèµ„æºæ¸…ç†æœºåˆ¶
- **ç»„ä»¶åè°ƒ**: ç»Ÿä¸€çš„ç»„ä»¶ç”Ÿå‘½å‘¨æœŸç®¡ç†å’ŒçŠ¶æ€ç›‘æ§
- **é…ç½®éªŒè¯**: æ™ºèƒ½çš„é…ç½®éªŒè¯å’Œé»˜è®¤å€¼è®¾ç½®

## ğŸ—ï¸ **ç³»ç»Ÿæ¶æ„**

### ç»„ä»¶ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FullyAsyncMain â”‚â”€â”€â”€â”€â”‚ MessageQueue    â”‚â”€â”€â”€â”€â”‚ FullyAsyncTrainerâ”‚
â”‚  (Coordinator)  â”‚    â”‚  (Ray Actor)    â”‚    â”‚   (Ray Actor)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Rollouter     â”‚
                    â”‚  (Ray Actor)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ParameterSync   â”‚
                    â”‚   Manager       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
1. æ•°æ®ç”Ÿæˆ: Rollouter â†’ MessageQueue
2. è®­ç»ƒæ¶ˆè´¹: MessageQueue â†’ FullyAsyncTrainer
3. å‚æ•°åŒæ­¥: FullyAsyncTrainer â†’ Rollouter
4. çŠ¶æ€ç›‘æ§: FullyAsyncMain â†’ All Components
```

## ğŸ“‹ **æ ¸å¿ƒç»„ä»¶**

### 1. FullyAsyncTrainer
- **åŠŸèƒ½**: ä»MessageQueueè·å–æ ·æœ¬è¿›è¡Œå¼‚æ­¥è®­ç»ƒ
- **ç‰¹æ€§**:
  - åŸºäºOneStepOffRayTrainerçš„æˆç†Ÿè®­ç»ƒé€»è¾‘
  - æ™ºèƒ½çš„æ ·æœ¬æ–°é²œåº¦æŒ‡æ ‡è®¡ç®—
  - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
  - è¯¦ç»†çš„è®­ç»ƒæ€§èƒ½ç›‘æ§

### 2. Rollouter
- **åŠŸèƒ½**: æŒç»­ç”Ÿæˆè®­ç»ƒæ ·æœ¬å¹¶æ”¾å…¥MessageQueue
- **ç‰¹æ€§**:
  - æ™ºèƒ½çš„æš‚åœ/æ¢å¤æ§åˆ¶æœºåˆ¶
  - åŸºäºæ–°é²œåº¦çš„ç”Ÿæˆæ§åˆ¶
  - æ”¹è¿›çš„å‚æ•°åŒæ­¥å¤„ç†
  - å¼‚æ­¥/åŒæ­¥ç”Ÿæˆæ¨¡å¼æ”¯æŒ

### 3. MessageQueue
- **åŠŸèƒ½**: Ray-basedæ¶ˆæ¯é˜Ÿåˆ—ï¼Œç®¡ç†æ ·æœ¬ä¼ é€’
- **ç‰¹æ€§**:
  - å»é™¤ZeroMQä¾èµ–ï¼Œæ›´ç¨³å®šå¯é 
  - æ™ºèƒ½çš„æ ·æœ¬è¿‡æœŸæ£€æµ‹
  - çº¿ç¨‹å®‰å…¨çš„é˜Ÿåˆ—æ“ä½œ
  - å†…å­˜ä½¿ç”¨ç›‘æ§

### 4. ParameterSynchronizer
- **åŠŸèƒ½**: ç®¡ç†Actorå’ŒRollouté—´çš„å‚æ•°åŒæ­¥
- **ç‰¹æ€§**:
  - æ”¯æŒé”™è¯¯é‡è¯•å’Œè¶…æ—¶å¤„ç†
  - è¯¦ç»†çš„åŒæ­¥çŠ¶æ€è·Ÿè¸ª
  - é›†ç¾¤é€šä¿¡ç»„ç®¡ç†

### 5. FullyAsyncMain
- **åŠŸèƒ½**: ç³»ç»Ÿåè°ƒå™¨ï¼Œç®¡ç†æ‰€æœ‰ç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸ
- **ç‰¹æ€§**:
  - ç»Ÿä¸€çš„ç»„ä»¶åˆå§‹åŒ–å’Œæ¸…ç†
  - å®æ—¶çš„å¥åº·çŠ¶æ€ç›‘æ§
  - ä¼˜é›…çš„å…³é—­å’Œé”™è¯¯æ¢å¤

## âš™ï¸ **é…ç½®è¯´æ˜**

### å¼‚æ­¥è®­ç»ƒé…ç½® (async_training)

```yaml
async_training:
  # æ–°é²œåº¦æ§åˆ¶
  staleness_threshold: 3              # æ ·æœ¬æ–°é²œåº¦é˜ˆå€¼
  max_staleness_allowed: 5            # æœ€å¤§å…è®¸çš„æ ·æœ¬é™ˆæ—§åº¦

  # é˜Ÿåˆ—ç®¡ç†
  max_queue_size: 1000               # æ¶ˆæ¯é˜Ÿåˆ—æœ€å¤§å¤§å°
  min_batch_count: 1                 # æ¯æ¬¡è·å–çš„æœ€å°batchæ•°é‡
  batch_timeout: 30.0                # è·å–batchçš„è¶…æ—¶æ—¶é—´

  # ç”Ÿæˆæ§åˆ¶
  generation_timeout: 30.0           # å•æ¬¡ç”Ÿæˆçš„è¶…æ—¶æ—¶é—´
  batch_generation_interval: 0.1     # batchç”Ÿæˆé—´éš”

  # å‚æ•°åŒæ­¥
  max_sync_retries: 3                # å‚æ•°åŒæ­¥æœ€å¤§é‡è¯•æ¬¡æ•°
  sync_timeout: 30.0                 # åŒæ­¥è¶…æ—¶æ—¶é—´
  sync_retry_delay: 1.0              # é‡è¯•å»¶è¿Ÿæ—¶é—´
```

### èµ„æºé…ç½®

```yaml
trainer:
  n_gpus_per_node: 4                 # æ¯ä¸ªè®­ç»ƒèŠ‚ç‚¹çš„GPUæ•°é‡
  nnodes: 2                          # è®­ç»ƒèŠ‚ç‚¹æ•°é‡
  device: cuda

rollout:
  n_gpus_per_node: 2                 # æ¯ä¸ªrolloutèŠ‚ç‚¹çš„GPUæ•°é‡
  nnodes: 1                          # rolloutèŠ‚ç‚¹æ•°é‡
```

## ğŸ”§ **ä½¿ç”¨æ–¹æ³•**

### 1. åŸºæœ¬è¿è¡Œ

```bash
# ä½¿ç”¨é»˜è®¤é…ç½®è¿è¡Œ
python fully_async_main.py

# ä½¿ç”¨è‡ªå®šä¹‰é…ç½®
python fully_async_main.py --config-path /path/to/config --config-name my_config
```

### 2. é…ç½®è‡ªå®šä¹‰

```python
# åœ¨é…ç½®æ–‡ä»¶ä¸­è‡ªå®šä¹‰å¼‚æ­¥è®­ç»ƒå‚æ•°
async_training:
  staleness_threshold: 5
  max_queue_size: 2000
  generation_timeout: 60.0
```

### 3. ç›‘æ§å’Œè°ƒè¯•

```python
# ç³»ç»Ÿä¼šè‡ªåŠ¨è¾“å‡ºè¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯
# åŒ…æ‹¬: TrainerçŠ¶æ€ã€RollouterçŠ¶æ€ã€é˜Ÿåˆ—çŠ¶æ€ç­‰

# æ—¥å¿—æ–‡ä»¶: fully_async_training.log
# åŒ…å«æ‰€æœ‰ç»„ä»¶çš„è¯¦ç»†æ—¥å¿—ä¿¡æ¯
```

## ğŸ“Š **æ€§èƒ½ç›‘æ§**

### å…³é”®æŒ‡æ ‡

#### TraineræŒ‡æ ‡
- `global_steps`: è®­ç»ƒæ­¥æ•°
- `processed_samples`: å·²å¤„ç†æ ·æœ¬æ•°
- `current_param_version`: å½“å‰å‚æ•°ç‰ˆæœ¬
- `param_sync_count`: å‚æ•°åŒæ­¥æ¬¡æ•°

#### RollouteræŒ‡æ ‡
- `total_generated_samples`: æ€»ç”Ÿæˆæ ·æœ¬æ•°
- `dropped_stale_samples`: ä¸¢å¼ƒçš„è¿‡æœŸæ ·æœ¬æ•°
- `generation_errors`: ç”Ÿæˆé”™è¯¯æ•°
- `param_sync_requests`: å‚æ•°åŒæ­¥è¯·æ±‚æ•°

#### æ–°é²œåº¦æŒ‡æ ‡
- `avg_sample_age`: æ ·æœ¬å¹³å‡å¹´é¾„
- `max_sample_age`: æ ·æœ¬æœ€å¤§å¹´é¾„
- `stale_samples_ratio`: è¿‡æœŸæ ·æœ¬æ¯”ä¾‹

#### é˜Ÿåˆ—æŒ‡æ ‡
- `queue_size`: å½“å‰é˜Ÿåˆ—å¤§å°
- `total_produced`: æ€»ç”Ÿäº§æ ·æœ¬æ•°
- `total_consumed`: æ€»æ¶ˆè´¹æ ·æœ¬æ•°
- `dropped_samples`: æ€»ä¸¢å¼ƒæ ·æœ¬æ•°

## ğŸ” **æ•…éšœæ’æŸ¥**

### å¸¸è§é—®é¢˜

1. **æ ·æœ¬ç”Ÿæˆè¿‡æ…¢**
   - æ£€æŸ¥ `generation_timeout` è®¾ç½®
   - ç›‘æ§ `generation_errors` æŒ‡æ ‡
   - è°ƒæ•´ `batch_generation_interval`

2. **æ ·æœ¬è¿‡æœŸä¸¥é‡**
   - è°ƒæ•´ `staleness_threshold`
   - æ£€æŸ¥å‚æ•°åŒæ­¥é¢‘ç‡
   - ç›‘æ§ `stale_samples_ratio`

3. **é˜Ÿåˆ—æº¢å‡º**
   - å¢åŠ  `max_queue_size`
   - ä¼˜åŒ–è®­ç»ƒé€Ÿåº¦
   - è°ƒæ•´ `min_batch_count`

4. **å‚æ•°åŒæ­¥å¤±è´¥**
   - æ£€æŸ¥ `sync_timeout` è®¾ç½®
   - ç›‘æ§ `sync_failures` æŒ‡æ ‡
   - è°ƒæ•´ `max_sync_retries`

### æ—¥å¿—åˆ†æ

```bash
# æŸ¥çœ‹ä¸»è¦é”™è¯¯
grep "ERROR" fully_async_training.log

# æŸ¥çœ‹ç»„ä»¶ç»Ÿè®¡
grep "Component Statistics" fully_async_training.log

# æŸ¥çœ‹å‚æ•°åŒæ­¥çŠ¶æ€
grep "Parameter sync" fully_async_training.log
```

## ğŸš€ **æ€§èƒ½ä¼˜åŒ–å»ºè®®**

### 1. èµ„æºé…ç½®ä¼˜åŒ–
- æ ¹æ®æ¨¡å‹å¤§å°åˆç†é…ç½®GPUæ•°é‡
- è®­ç»ƒå’Œrolloutä½¿ç”¨ç‹¬ç«‹çš„èµ„æºæ± 
- è€ƒè™‘å†…å­˜å’Œè®¡ç®—çš„å¹³è¡¡

### 2. æ–°é²œåº¦æ§åˆ¶ä¼˜åŒ–
- æ ¹æ®æ¨¡å‹æ”¶æ•›é€Ÿåº¦è°ƒæ•´æ–°é²œåº¦é˜ˆå€¼
- ç›‘æ§æ ·æœ¬å¹´é¾„åˆ†å¸ƒï¼Œé¿å…è¿‡åº¦ä¸¢å¼ƒ
- åŠ¨æ€è°ƒæ•´é˜Ÿåˆ—å¤§å°

### 3. å‚æ•°åŒæ­¥ä¼˜åŒ–
- åˆç†è®¾ç½®åŒæ­¥é¢‘ç‡ï¼Œå¹³è¡¡æ€§èƒ½å’Œä¸€è‡´æ€§
- ä½¿ç”¨å¼‚æ­¥åŒæ­¥å‡å°‘ç­‰å¾…æ—¶é—´
- ç›‘æ§åŒæ­¥è€—æ—¶ï¼ŒåŠæ—¶å‘ç°é—®é¢˜

## ğŸ”§ **æ‰©å±•å’Œå®šåˆ¶**

### è‡ªå®šä¹‰ç»„ä»¶

```python
# è‡ªå®šä¹‰Trainer
class CustomFullyAsyncTrainer(FullyAsyncTrainer):
    def _compute_custom_metrics(self, batch):
        # æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡è®¡ç®—
        pass

# è‡ªå®šä¹‰Rollouter
class CustomRollouter(Rollouter):
    def _custom_generation_logic(self, batch):
        # æ·»åŠ è‡ªå®šä¹‰ç”Ÿæˆé€»è¾‘
        pass
```

### è‡ªå®šä¹‰ç›‘æ§

```python
# æ·»åŠ è‡ªå®šä¹‰ç›‘æ§æŒ‡æ ‡
def custom_monitor(trainer_stats, rollouter_stats):
    # å®ç°è‡ªå®šä¹‰ç›‘æ§é€»è¾‘
    custom_metric = calculate_custom_metric(trainer_stats)
    logger.info(f"Custom metric: {custom_metric}")
```

## ğŸ“š **ä¸OneStepOffRayTrainerçš„å¯¹æ¯”**

| ç‰¹æ€§ | OneStepOffRayTrainer | FullyAsyncTrainer |
|------|---------------------|------------------|
| è®­ç»ƒæ¨¡å¼ | åŒæ­¥æ‰¹å¤„ç† | å¼‚æ­¥æµå¤„ç† |
| å‚æ•°æ›´æ–° | æ‰¹æ¬¡åŒæ­¥æ›´æ–° | å®æ—¶å¼‚æ­¥æ›´æ–° |
| èµ„æºåˆ©ç”¨ | é˜¶æ®µæ€§åˆ©ç”¨ | æŒç»­é«˜æ•ˆåˆ©ç”¨ |
| æ–°é²œåº¦æ§åˆ¶ | æ— éœ€è€ƒè™‘ | æ™ºèƒ½æ§åˆ¶ |
| å¤æ‚åº¦ | ç›¸å¯¹ç®€å• | æ›´å¤æ‚ä½†æ›´çµæ´» |
| é€‚ç”¨åœºæ™¯ | æ ‡å‡†è®­ç»ƒ | å¤§è§„æ¨¡æŒç»­è®­ç»ƒ |

## ğŸ“– **æœ€ä½³å®è·µ**

1. **é…ç½®è°ƒä¼˜**: ä»é»˜è®¤é…ç½®å¼€å§‹ï¼Œæ ¹æ®ç›‘æ§æŒ‡æ ‡é€æ­¥ä¼˜åŒ–
2. **èµ„æºè§„åˆ’**: åˆç†åˆ†é…è®­ç»ƒå’Œç”Ÿæˆèµ„æºï¼Œé¿å…ç“¶é¢ˆ
3. **ç›‘æ§é¢„è­¦**: è®¾ç½®å…³é”®æŒ‡æ ‡çš„é˜ˆå€¼æŠ¥è­¦
4. **å®šæœŸæ£€æŸ¥**: å®šæœŸæ£€æŸ¥æ—¥å¿—å’Œæ€§èƒ½æŒ‡æ ‡
5. **ç‰ˆæœ¬ç®¡ç†**: è®°å½•é…ç½®å˜æ›´å’Œæ€§èƒ½å½±å“

## ğŸ¤ **è´¡çŒ®å’Œåé¦ˆ**

æ¬¢è¿æäº¤issueå’ŒPRæ¥æ”¹è¿›è¿™ä¸ªå¼‚æ­¥è®­ç»ƒç³»ç»Ÿï¼

## ğŸ“„ **æ›´æ–°æ—¥å¿—**

### v2.0 (æ”¹è¿›ç‰ˆæœ¬)
- âœ… åŸºäºOneStepOffRayTraineré‡æ„è®­ç»ƒé€»è¾‘
- âœ… ç®€åŒ–MessageQueueå®ç°ï¼Œå»é™¤ZeroMQä¾èµ–
- âœ… æ”¹è¿›å‚æ•°åŒæ­¥æœºåˆ¶ï¼Œæ”¯æŒé”™è¯¯é‡è¯•
- âœ… å®Œå–„ç»„ä»¶åè°ƒå’Œç›‘æ§ç³»ç»Ÿ
- âœ… ä¼˜åŒ–é”™è¯¯å¤„ç†å’Œèµ„æºç®¡ç†
- âœ… å¢åŠ è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡å’Œæ—¥å¿—

### v1.0 (åŸå§‹ç‰ˆæœ¬)
- åŸºç¡€å¼‚æ­¥è®­ç»ƒæ¡†æ¶
- ç®€å•çš„æ¶ˆæ¯é˜Ÿåˆ—å®ç°
- åŸºæœ¬çš„å‚æ•°åŒæ­¥åŠŸèƒ½


```python
DataProtoItem(
    batch=TensorDict(
        fields={
            attention_mask: Tensor(shape=torch.Size([3072]), device=cpu, dtype=torch.int64, is_shared=False),
            input_ids: Tensor(shape=torch.Size([3072]), device=cpu, dtype=torch.int64, is_shared=False),
            position_ids: Tensor(shape=torch.Size([3072]), device=cpu, dtype=torch.int64, is_shared=False),
            prompts: Tensor(shape=torch.Size([1024]), device=cpu, dtype=torch.int64, is_shared=False),
            response_mask: Tensor(shape=torch.Size([2048]), device=cpu, dtype=torch.int64, is_shared=False),
            responses: Tensor(shape=torch.Size([2048]), device=cpu, dtype=torch.int64, is_shared=False)},
        batch_size=torch.Size([]),
        device=None,
        is_shared=False), 
    non_tensor_batch={'data_source': 'openai/gsm8k',
                      'ability': 'math', 
                      'reward_model': {'ground_truth': '35', 'style': 'rule'},
                      'extra_info': {
                          'answer': 'The total number of green and red plates is 28 + 21 = <<28+21=49>>49.\nXavier should buy 84 âˆ’ 49 = 35 more plates.\n#### 35',
                          'index': 1421, 
                          'question': 'Xavier needs 84 paper plates for a housewarming party. He already has 21 green plates and 28 red plates. How many more plates should Xavier buy?', 'split': 'train'},
                      'uid': 'fab3e910-67b3-4653-bc69-377250049267', 
                      'tools_kwargs': {}, 
                      'interaction_kwargs': {}, 
                      'index': 1421},
    meta_info={'global_token_num': [2141, 2141, 2161, 2151, 2151, 2130, 2141, 2161, 2161, 2151, 2130, 2130]})
```

